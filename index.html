<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://redirector-staging.eservice.emarsys.com/ui/latest/css/app.css">
  <link rel="stylesheet" href="https://redirector-staging.eservice.emarsys.com/ui/latest/css/services/contentblocks.css">
  <script src="https://redirector-staging.eservice.emarsys.com/ui/latest/js/app.js"></script>
  <script src='https://redirector-staging.eservice.emarsys.com/content-blocks-positioner/latest/app.js'></script>
  <script src="//redirector-staging.eservice.emarsys.com/vce-preview/latest/scripts/vce-preview.js"></script>
  <script type="text/javascript" src="./vce.js"></script>
</head>
<body>
<style>
  .wrap {
    height: 99vh;
    border: 1px solid green;
  }

  .vce-wrap {
    width: 100%;
    height: 100%;
  }
</style>
<div class="wrap">
  <vce-preview id="preview" extra-class="vce-wrap">
    <vce-plugin-prevent-link-click></vce-plugin-prevent-link-click>
    <vce-plugin-force-http-image-link></vce-plugin-force-http-image-link>
    <vce-plugin-clean-device-width></vce-plugin-clean-device-width>
    <vce-plugin-clean-pixel-ratio></vce-plugin-clean-pixel-ratio>
    <vce-link-editor-dialog selector="a[e-editable]"
                            link-editor-dialog="link-editor-dialog"></vce-link-editor-dialog>
    <vce-plugin-editable-text
      editable-selector="p[e-editable],div[e-editable],h1[e-editable],h2[e-editable],h3[e-editable]"
      fonts='["Arial=arial"]'
      font-sizes='["6px 7px","11px 12px"]'
      change="change"
      tinymce-plugins='["paste","textcolor","colorpicker","noneditable","foreColorPatch"]'
      toolbar='["forecolor | bold italic underline strikethrough | personalization conditionalEditor | linkEditor",
                                          "fontselect | fontsizeselect | removeformat"]' change="textChange">
      <vce-plugin-text-inner-link-editor external-plugin="external-plugin">
        <vce-link-editor-dialog
          link-editor-dialog="link-editor-dialog"></vce-link-editor-dialog>
      </vce-plugin-text-inner-link-editor>
    </vce-plugin-editable-text>
    <vce-plugin-toolbar selector="img[e-editable]">
      <vce-plugin-image-link-editor
        toolbar-button="toolbar-button"
        change="imageLinkChange">
        <vce-link-editor-dialog
          link-editor-dialog="link-editor-dialog"></vce-link-editor-dialog>
      </vce-plugin-image-link-editor>
      <vce-plugin-image-properties toolbar-button="toolbar-button"
                                   change="imagePropertiesChange">
        <vce-image-properties-dialog image-properties-dialog="image-properties-dialog">
          <open-media-db open-media-db="open-media-db"></open-media-db>
          <vce-image-properties-dialog-tab label="Desktop" name="default">
            <vce-ipd-url-warning vce-ipd-warning="vce-ipd-warning"></vce-ipd-url-warning>
            <vce-ipd-alt-text-warning vce-ipd-warning="vce-ipd-warning"></vce-ipd-alt-text-warning>
            <vce-ipd-mso-warning vce-ipd-warning="vce-ipd-warning"></vce-ipd-mso-warning>
            <vce-ipd-dimension-warning vce-ipd-warning="vce-ipd-warning"></vce-ipd-dimension-warning>
          </vce-image-properties-dialog-tab>
        </vce-image-properties-dialog>
      </vce-plugin-image-properties>
    </vce-plugin-toolbar>
  </vce-preview>
</div>
<script>
  let data = window.data;
  const replaceEditables = window.replaceEditables;
  const replaceVariables = window.replaceVariables;
  const STYLE_ANCHOR = '#style#';
  const BODY_ANCHOR = '#body#';
  const DELIMITER = '___';

  class VCECampaign {
    constructor (obj) {
      this.data = obj;
      this.templates = obj.available_block_templates.reduce((acc, item) => {
        acc[item._id] = item;
        return acc;
      }, {});
      this.blocks = obj.blocks.map(block => new Block(block, this.templates[block.template].html));
      this.blockMap = this.blocks.reduce((acc, item) => {
        acc[item.data._id] = item;
        return acc;
      }, {});
      this.onRender = a => a;
    }

    get parsed () {
      return replaceVariables(this.data.variables, this.data.frame.html
        .replace(STYLE_ANCHOR, `<style>${this.data.frame.style}</style>`)
        .replace(BODY_ANCHOR, this.blocks.reduce((acc, item) => acc.concat(item.parsed), '')));
    }

    handleChange (e) {
      e = e.detail;
      ((blockId, editableId) => {
        delete e.editableId;
        this.blockMap[blockId].handleChange(editableId, e);
        if (['imageData', 'linkData'].includes(Object.keys(e)[0])) {
          this.onRender();
        }
      })(...e.editableId.split(DELIMITER));
    }

    onRenderRequest (cb) {
      this.onRender = cb;
    }
  }

  class Block {
    constructor (obj, template) {
      this.data = obj;
      this.template = template;
    }

    decorate (html) {
      let wrap = document.createElement('DIV');
      wrap.innerHTML = html;
      wrap.querySelectorAll('[e-editable]').forEach(editable => {
        editable.setAttribute('e-editable', `${this.data._id}${DELIMITER}${editable.getAttribute('e-editable')}`);
      });
      return wrap.innerHTML;
    }

    handleChange (editableId, data) {
      this.data.content = this.data.content || {};
      this.data.content[editableId] = ({
        data: d => ({ value: d.data }),
        linkData: d => ({ attributes: d.linkData }),
        imageData: d => ({ attributes: d.imageData.default.attributes })
      }[Object.keys(data)[0]] || (a => a))(data);
    }

    get parsed () {
      return this.decorate(replaceEditables(this.template, this.data.content));
    }
  }

  function addChangeListener (domElm, cb) {
    domElm.querySelectorAll(`vce-plugin-editable-text,
  vce-plugin-image-link-editor,
  vce-plugin-image-properties,
  vce-plugin-text-inner-link-editor`).forEach(editablePlugin => editablePlugin.addEventListener('change', cb));
  }

  let vce = document.querySelector('vce-preview');
  let camp = new VCECampaign(data);
  vce.setAttribute('content', camp.parsed);
  addChangeListener(vce, camp.handleChange.bind(camp));
  camp.onRenderRequest(() => vce.setAttribute('content', camp.parsed));

</script>
</body>
</html>
